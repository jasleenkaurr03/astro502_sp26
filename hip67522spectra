# ==== DOWNLOAD HIP 67522 DATA FROM ESO ARCHIVE AND PLOT ====

# astroquery to import all the ESO data
from astroquery.eso import Eso
from astropy.io import fits
import numpy as np
import matplotlib.pyplot as plt
import os

# retrieve file from targets directly from Eso database using astroquery
eso = Eso()
query = 'HIP 67522' # find from target list (on Dr. Mann repo)

# below code generated by me, modified by ChatGPT to open all results
results = eso.query_surveys(target="HIP 67522", survey="HARPS")
print(results.colnames)
print(results[:10])

# below code generated with help of ChatGPT to get only spectral results
# if the column exists
if "Product category" in results.colnames:
    spec_rows = [("SPECTRUM" in str(x)) for x in results["Product category"]]
    spec = results[spec_rows]
else:
    spec = results
print("Total rows:", len(results))
print("Spectrum-like rows:", len(spec))
print(spec[:10])

# below code generated with help of ChatGPT to get only files containing spectral info
# choose which table to download from: spec if non-empty, else results
use = spec if len(spec) > 0 else results
# pick first row for now
arc = use["ARCFILE"][0]
print("Downloading ARCFILE:", arc)
downloaded = eso.retrieve_data(arc)
print("Downloaded:", downloaded)

# below code generated with help of ChatGPT to check if file type downloaded correctly as BinTableHDU
path = downloaded[0] if isinstance(downloaded, (list, tuple)) else downloaded
hdul = fits.open(path)
hdul.info()
# WAVE / FLUX INFO IN BinTableHDU 

# all below code generated by me

hip67522 = fits.open('/Users/jasleenkaur/.astropy/cache/astroquery/Eso/ADP.2025-02-21T08:21:54.067.fits')

# code from wasp136test on GitHub - just changed 
data = hip67522[1].data
print(data.columns)
# WAVE = wavelengths, FLUX = flux changing

# make plot of flux vs. wavelength 
# index first of the columns because if just doing data['WAVE'] it creates array in array
xvals = data['WAVE'][0] # wavelength
yvals = data['FLUX'][0] # flux

plt.plot(xvals, yvals)
plt.xlabel('Wavelength (Å)')
plt.ylabel('Flux') 
plt.title('Full Spectrum of Flux vs. Wavelength of HIP 67522') 
plt.autoscale(enable=True, axis='both', tight=True)

plt.show()

# === OUTPUT NOTES BELOW: NO USEFUL SPECTRA OBTAINED ===
# looking at wavelengths from full spectra they range from ~10000-18000 Å 
# These are infrared wavelengths and don't contain the wavelengths we are interested in
