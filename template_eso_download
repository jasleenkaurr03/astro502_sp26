# ==== DOWNLOAD ***STAR*** DATA FROM ESO ARCHIVE AND PLOT ====

# astroquery to import all the ESO data
from astroquery.eso import Eso
from astropy.io import fits
import numpy as np
import matplotlib.pyplot as plt
import os



# retrieve file from targets directly from Eso database using astroquery
eso = Eso()
query = '***STAR***' # find from target list (on Dr. Mann repo)
instrument = '***INSTRUMENT***' # HARPS, UVES, ESPRESSO, FEROS

# below code generated by me, modified by ChatGPT to open all results
results = eso.query_surveys(target=query, surveys=instrument) 
print(results.colnames)
print(results[:10])



# below code generated with help of ChatGPT to get only spectral results
# if the column exists
if "Product category" in results.colnames:
    spec_rows = [("SPECTRUM" in str(x)) for x in results["Product category"]]
    spec = results[spec_rows]
else:
    spec = results
print("Total rows:", len(results))
print("Spectrum-like rows:", len(spec))
print(spec[:10])



# below code generated with help of ChatGPT to get only files containing spectral info
# choose which table to download from: spec if non-empty, else results
use = spec if len(spec) > 0 else results
# pick first row for now
arc = use["ARCFILE"][0]
print("Downloading ARCFILE:", arc)
downloaded = eso.retrieve_data(arc)
print("Downloaded:", downloaded) # will output a path



# below code generated with help of ChatGPT to check if file type downloaded correctly as BinTableHDU
path = downloaded[0] if isinstance(downloaded, (list, tuple)) else downloaded
hdul = fits.open(path)
hdul.info()
# WAVE / FLUX INFO IN BinTableHDU 



# all below code generated by me

star = query
star_data = fits.open(downloaded)

# check that WAVE and FLUX are column names
data = star_data[1].data
print(data.columns)
# WAVE = wavelengths, FLUX = flux changing



# make plot of flux vs. wavelength 
# index first of the columns because if just doing data['WAVE'] it creates array in array
xvals = data['WAVE'][0] # wavelength
yvals = data['FLUX'][0] # flux

# wavelength range
xmin = xvals[0]
xmax = xvals[-1]

plt.plot(xvals, yvals, color='tab:pink')
plt.xlabel('Wavelength (Å)')
plt.ylabel('Flux') 
plt.title(f'Full Spectrum: {star}, Instrument: {instrument}\nWavelengths from {xmin:.2f} to {xmax:.2f} Å') 
plt.autoscale(enable=True, axis='both', tight=True)

# save figure
filename = f"Spectrum_{star}_{instrument}_{xmin:.2f}-{xmax:.2f}.png"
plt.savefig(filename)
plt.show()

# looking at wavelengths from full spectra they range from ~6000-9000 Å 



# make 4 subplots to show each line
# Lithium: 6708 Å
# H-alpha: 6562.801 Å
# Ca II H & K: 3933 Å & 3968 Å


# create 2x2 array of graphs and space out/enlarge by changing figsize
figures, graphs = plt.subplots(2, 2, figsize=(10, 8))


# overall figure title
plt.suptitle(f'\nContinuum Around Key Spectral Features for {star}', fontsize=16)
plt.subplots_adjust(hspace=0.3)


# H-alpha (hydrogen) line at 6562.801 Angstrom 
graphs[0,0].plot(xvals, yvals, 'tab:pink')
graphs[0,0].set_xlim(6500, 6600) 

# automate y-axis rescaling 
mask1 = (xvals >= 6500) & (xvals <= 6600)
ymin1 = yvals[mask1].min()
ymax1 = yvals[mask1].max()

graphs[0,0].set_ylim(
    yvals[mask1].min(),
    yvals[mask1].max()
)
pad1 = 0.1 * (ymax1 - ymin1)   # 10% buffer
graphs[0,0].set_ylim(ymin1 - pad1, ymax1 + pad1)

graphs[0,0].set_title(r'H-alpha Peak at 6562.801 $\AA$')
graphs[0,0].axvline(x=6562.801, color='black', ls='--') # fixed from 6563 Å to 6562.801 Å


# lithium line at 6707.76 Angstrom
graphs[0,1].plot(xvals, yvals, 'tab:purple')
graphs[0,1].set_xlim(6700, 6715)

mask2 = (xvals >= 6700) & (xvals <= 6715)
ymin2 = yvals[mask2].min()
ymax2 = yvals[mask2].max()

graphs[0,1].set_ylim(
    yvals[mask2].min(),
    yvals[mask2].max()
)
pad2 = 0.1 * (ymax2 - ymin2)   # 10% buffer
graphs[0,1].set_ylim(ymin2 - pad2, ymax2 + pad2)
graphs[0,1].set_title(r'Lithium Peak at 6707.76 $\AA$')
graphs[0,1].axvline(x=6707.76, color='black', ls='--')


# Ca II H line at 3933 Angstrom
graphs[1,0].plot(xvals, yvals, '#71C7A0')
graphs[1,0].set_xlim(3900, 3960)

mask3 = (xvals >= 3900) & (xvals <= 3960)
ymin3 = yvals[mask3].min()
ymax3 = yvals[mask3].max()

graphs[1,0].set_ylim(
    yvals[mask3].min(),
    yvals[mask3].max()
)
pad3 = 0.1 * (ymax3 - ymin3)   # 10% buffer
graphs[1,0].set_ylim(ymin3 - pad3, ymax3 + pad3)

graphs[1,0].set_title(r'Ca II H line at 3933 $\AA$')
graphs[1,0].axvline(x=3933, color='black', ls='--')


# Ca II K line at 3968 Angstom
graphs[1,1].plot(xvals, yvals, '#4B9CD3')
graphs[1,1].set_xlim(3960, 4000)

mask4 = (xvals >= 3960) & (xvals <= 4000)
ymin4 = yvals[mask4].min()
ymax4 = yvals[mask4].max()

graphs[1,1].set_ylim(
    yvals[mask4].min(),
    yvals[mask4].max()
)
pad4 = 0.1 * (ymax4 - ymin4)   # 10% buffer
graphs[1,1].set_ylim(ymin4 - pad4, ymax4 + pad4)

graphs[1,1].set_title(r'Ca II K line at 3968 $\AA$')
graphs[1,1].axvline(x=3968, color='black', ls='--')

# save figure
filename2 = f"Features_{star}_{instrument}.png"
plt.savefig(filename2)
plt.show()
